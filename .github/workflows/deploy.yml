name: ğŸš€ Deploy to Kubernetes

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository }}
  APP_VERSION: 1.0.0

jobs:
  test:
    name: ğŸ§ª Test y Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Lint Dockerfile
      uses: hadolint/hadolint-action@v3.0.0
      with:
        dockerfile: Dockerfile

    - name: ğŸ³ Build Docker image
      run: |
        docker build -t $IMAGE_REGISTRY/$IMAGE_REPO:$GITHUB_SHA .
        docker build -t $IMAGE_REGISTRY/$IMAGE_REPO:latest .

    - name: ğŸ§ª Test de la imagen
      run: |
        docker run --rm $IMAGE_REGISTRY/$IMAGE_REPO:$GITHUB_SHA php -v
        docker run --rm $IMAGE_REGISTRY/$IMAGE_REPO:$GITHUB_SHA curl -f http://localhost/ || echo "App started correctly"

  deploy-dev:
    name: ğŸš€ Deploy to Development
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.IMAGE_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ³ Build and Push Image
      run: |
        docker build -t $IMAGE_REGISTRY/$IMAGE_REPO:$GITHUB_SHA .
        docker push $IMAGE_REGISTRY/$IMAGE_REPO:$GITHUB_SHA

    - name: ğŸ”§ Deploy to Kubernetes
      run: |
        # Reemplazar variables en los YAMLs
        envsubst < k8s/deployment.yml > deployment-final.yml
        kubectl apply -f deployment-final.yml
        kubectl apply -f k8s/service.yml
        kubectl apply -f k8s/route.yml
      env:
        IMAGE_REGISTRY: ${{ env.IMAGE_REGISTRY }}
        IMAGE_REPO: ${{ env.IMAGE_REPO }}
        GITHUB_SHA: ${{ github.sha }}
        APP_VERSION: ${{ env.APP_VERSION }}
        DB_HOST: mysql-dev

    - name: ğŸ“Š Verificar despliegue
      run: |
        kubectl get pods -l app=mi-app
        kubectl get services mi-app-service

  deploy-prod:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.IMAGE_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ³ Build and Push Image
      run: |
        docker build -t $IMAGE_REGISTRY/$IMAGE_REPO:$GITHUB_SHA .
        docker build -t $IMAGE_REGISTRY/$IMAGE_REPO:latest .
        docker push $IMAGE_REGISTRY/$IMAGE_REPO:$GITHUB_SHA
        docker push $IMAGE_REGISTRY/$IMAGE_REPO:latest

    - name: ğŸš€ Deploy to Production
      run: |
        envsubst < k8s/deployment.yml > deployment-final.yml
        kubectl apply -f deployment-final.yml
        kubectl apply -f k8s/service.yml
        kubectl apply -f k8s/route.yml
        
        # Esperar que estÃ© listo
        kubectl rollout status deployment/mi-app --timeout=300s
      env:
        IMAGE_REGISTRY: ${{ env.IMAGE_REGISTRY }}
        IMAGE_REPO: ${{ env.IMAGE_REPO }}
        GITHUB_SHA: ${{ github.sha }}
        APP_VERSION: ${{ env.APP_VERSION }}
        DB_HOST: mysql-prod
